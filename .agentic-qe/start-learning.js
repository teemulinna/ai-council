#!/usr/bin/env node
/**
 * Nightly-Learner Startup Script
 * Generated by aqe init
 *
 * Run this script to start the learning scheduler:
 *   node .agentic-qe/start-learning.js
 *
 * Or add to your application startup.
 */

const path = require('path');

async function startLearning() {
  try {
    // Load configuration
    const config = require('./learning-config.json');

    if (!config.enabled) {
      console.log('[Nightly-Learner] Learning is disabled in config');
      return;
    }

    // Import scheduler
    const { SleepScheduler } = require('agentic-qe/dist/learning/scheduler/SleepScheduler');

    // Create and start scheduler
    const scheduler = new SleepScheduler({
      mode: config.scheduler.mode,
      schedule: config.scheduler.schedule,
      learningBudget: config.scheduler.learningBudget,
    });

    scheduler.on('scheduler:started', (state) => {
      console.log('[Nightly-Learner] Scheduler started:', state.mode);
    });

    scheduler.on('sleep:start', (cycle) => {
      console.log('[Nightly-Learner] Learning cycle started');
    });

    scheduler.on('sleep:end', (summary) => {
      console.log('[Nightly-Learner] Learning cycle complete:', {
        patternsDiscovered: summary.patternsDiscovered,
        agentsProcessed: summary.agentsProcessed.length,
      });
    });

    scheduler.on('error', (error) => {
      console.error('[Nightly-Learner] Error:', error);
    });

    await scheduler.start();
    console.log('[Nightly-Learner] System running. Press Ctrl+C to stop.');

    // Handle graceful shutdown
    process.on('SIGINT', async () => {
      console.log('\n[Nightly-Learner] Shutting down...');
      await scheduler.stop();
      process.exit(0);
    });

  } catch (error) {
    console.error('[Nightly-Learner] Failed to start:', error);
    process.exit(1);
  }
}

startLearning();
